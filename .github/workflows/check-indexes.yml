name: Check Indexes

on:
  workflow_call:

jobs:
  check-indexes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check Migration Indexes
        uses: speedshop/ids_must_be_indexed@v1.2.3

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [check-indexes]
    if: failure()
    steps:
      - name: Send failure notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.postmarkapp.com
          server_port: 587
          secure: false
          username: ${{ secrets.POSTMARK_NOTIFICATIONS_SMTP_TOKEN }}
          password: ${{ secrets.POSTMARK_NOTIFICATIONS_SMTP_TOKEN }}
          subject: "❌ GitHub Action Failed: ${{ github.repository }} – ${{ github.workflow }}"
          to: ${{ secrets.WORKFLOW_TO_EMAIL }}
          from: ${{ secrets.WORKFLOW_FROM_EMAIL }}
          body: |
            Workflow:  ${{ github.workflow }}
            Branch:    ${{ github.ref_name }}
            Commit:    ${{ github.event.head_commit.message || 'N/A' }}
            SHA:       ${{ github.sha }}
            Author:    ${{ github.actor }}
            Triggered: ${{ github.event_name }}

            Job Results:
              check-indexes: ${{ needs.check-indexes.result }}

            View run:  ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
